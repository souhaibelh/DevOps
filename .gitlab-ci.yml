stages:
  - build
  - test
  - docker-build
  - deploy

spring-build-job:
  stage: build
  image: eclipse-temurin:17-jdk-alpine
  rules:
    - changes:
        - service-java/**/*
  script:
    - chmod +x ./service-java/mvnw
    - ./service-java/mvnw -f ./service-java/pom.xml compile

python-build-job:
  stage: build
  image: python:3.12-slim
  rules:
    - changes:
        - service-python/**/*
  script:
    - pip install -r ./service-python/requirements.txt
    - python -m compileall ./service-python

spring-test-job:
  stage: test
  image: eclipse-temurin:17-jdk-alpine
  rules:
    - changes:
        - service-java/**/*
  script:
    - chmod +x ./service-java/mvnw
    - ./service-java/mvnw -f ./service-java/pom.xml test

python-test-job:
  stage: test
  image: python:3.12-slim
  rules:
    - changes:
        - service-python/**/*  
  script:
    - pip install -r ./service-python/requirements.txt
    - pip install pytest
    - pytest ./service-python/test_app.py

docker-spring-build-job:
  stage: deploy
  image: docker:28.3.3-cli
  services:
    - docker:28.3.3-dind
  rules:
    - changes:
        - service-java/**/*  
  variables:
    DOCKER_TLS_CERTDIR: ""
  before_script:
    - docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD
  script:
    - docker build -t $DOCKER_USERNAME/spring-boot-app:1.0 -f ./service-java/spring.Dockerfile ./service-java
    - docker push $DOCKER_USERNAME/spring-boot-app:1.0

docker-python-build-job:
  stage: deploy
  image: docker:28.3.3-cli
  services:
    - docker:28.3.3-dind
  rules:
    - changes:
        - service-python/**/*  
  variables:
    DOCKER_TLS_CERTDIR: ""
  before_script:
    - docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD
  script:
    - docker build -t $DOCKER_USERNAME/flask:1.0 -f ./service-python/flask.Dockerfile ./service-python
    - docker push $DOCKER_USERNAME/flask:1.0

terraform-deploy-job:
  image: 
    name: hashicorp/terraform:1.6.5
    entrypoint: [""]
  stage: deploy
  needs:
    - job: docker-spring-build-job
    - job: docker-python-build-job
  rules:
    - changes:
        - service-python/**/*   
        - service-java/**/* 
  variables:
    ARM_CLIENT_ID: $AZURE_CLIENT_ID
    ARM_CLIENT_SECRET: $AZURE_CLIENT_SECRET
    ARM_TENANT_ID: $AZURE_TENANT_ID
    ARM_SUBSCRIPTION_ID: $AZURE_SUBSCRIPTION_ID
    TF_VAR_docker_username: $DOCKER_USERNAME
    TF_VAR_docker_password: $DOCKER_TERRAFORM_PASSWORD
  script:
    - terraform init
    - terraform apply -auto-approve